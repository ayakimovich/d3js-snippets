<!doctype html>
<!--
uViewer
Copyright (c) Artur Yakimovich, PhD, 2016-2017.
HTML5, JavaScript, D3 based Figure viewer for high definition microscopy images.
MIT License.
NB: relies on a working internet connection for the libraries.
-->
<html>
<head>
  <title>uViewer - dynamic viewer of multichannel superresolution micrscopy</title>
  <link rel="shortcut icon" href="data:image/png;base64,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
  0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvy
  F1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hC
  epkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmd
  lV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0m
  ek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeL
  Z5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7
  z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZz
  G4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fy
  z4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nue
  r21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89
  HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xm
  v28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5
  /wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAllJREFUeNq8102ITWEYB/DfHXfGxghDmmbho2HUZEOElAVSk8hOYWGJlZqys
  LO2kLKRsFGKhYWIDaJhykfUWFiomfGxkDEMMSZzbJ6r2517z73nTsdbb6fzvOc8///zvs/XK0kSSZLIcXSgp1L4D/c/ELiABC
  fQFrLC/yAwF2cCvDRHsDPvHShgES5WgJfmbSzJk0AfHtYAH8XyPHegBy9rgL9DV55OuBlPMV4FfBxr8oyCAzWsLs1dswnDDVi
  Wst6Nrynge6v9lIXA8VB0tIbHP4j16QrgSWyvpTTrEfRhCp/LsloLbqRYvj9NYTM+MAf3Q3kX+lPA++spm40TrsVwCvjpRpTM
  hsBW/KgBfq5RJc0SOJJi+cksVjRD4FgK+K2siSMrgW34WQX4dzwv5U1gsIblV6K8JuEbuRHoxOUK8CHMi/XnGMjbB5Q1GKPRa
  pXGnpB3500AerG+inwY17ISKDZR+Ybi2YrF+BjvI/hV9l1btGUTacqKddYOYWO0WK/wHVtCeSt24DXuRMX8gN3x/TjuNn4WM0
  c7vtWp82lzsBHcljopt72BI5nGnyrysUbOs1in+j0uywFTUQUHsABL8SJ6wKtRH07Ff0vxJFs4ND/O4nzembDapeMwnkU21Cy
  BQgm8UCjMwSasiN59KkLrS2x5b/R+RRyM93ux7evwBu/j7CfKQnU82rMZBCqPoAM3M3r6WGTFP/gUBetthGMS98KGE9H8sDTL
  WBhTJCWxg+XJqOEo2IdVeBTWtJV1uqtDXogLxmQkpbGwujMMmAh5EStxvR6BvwMAzYYNeIWwSOMAAAAASUVORK5CYII="/>

  <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript">
    function uViewer() {
      var   imageFolder = "/Users/ayakimovich/github/d3js-snippets/png/",
            rgbImageFileName = "RGB.png",
            redImageFileName = "D06-D05-D04_Maximum-0003.png",
            greenImageFileName = "D06-D05-D04_Maximum-0002.png",
            blueImageFileName = "D06-D05-D04_Maximum-0001.png",
            grayImageFileName = "D06-D05-D04_Maximum-0004.png";

      function imagePreload(src) {
          var img = new Image();
          img.src = src;
          return img
      }

      function mainSVG(rgbImage, redImage, greenImage, blueImage, grayImage){
              //main svg start
              console.log("uViewer start")
              var svgWidth = 800,
                  svgHeight = 600,
                  r = 0,
                  imagePadding = 5,
                  scaleBarSize = 20,
                  micronPixelRatio = 31.015,
                  scaleBarHeight = 5,
                  rgbWidth = 300,
                  rgbHeight = 300,
                  rgbX = 5,
                  rgbY = 5;

              var zoomPaneWidth = rgbWidth/2 - imagePadding,
                  zoomPaneHeight = rgbHeight/2 - imagePadding,
                  scaleBarX = imagePadding*2,
                  scaleBarY = rgbHeight - imagePadding - scaleBarHeight,
                  rgbZoomPaneWidth = 80,
                  rgbZoomPaneHeight = 80,
                  rgbZoomPaneX = rgbWidth - imagePadding - rgbZoomPaneWidth,
                  rgbZoomPaneY = rgbY + imagePadding*2,
                  redZoomPaneX = rgbWidth + imagePadding*2,
                  redZoomPaneY = imagePadding + Math.floor(imagePadding/2),
                  greenZoomPaneX = redZoomPaneX + imagePadding + zoomPaneWidth,
                  greenZoomPaneY = imagePadding + Math.floor(imagePadding/2),
                  blueZoomPaneX = redZoomPaneX,
                  blueZoomPaneY = zoomPaneHeight + imagePadding*2 + Math.floor(imagePadding/2),
                  grayZoomPaneX = redZoomPaneX + imagePadding + zoomPaneWidth,
                  grayZoomPaneY = blueZoomPaneY;

              var svg = d3.select("body").select("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);
              //update parameters
              d3.select("#bigRGBImage")
                .attr({
                  "height": rgbHeight,
                  "width": rgbWidth,
                  "x" : rgbX,
                  "y" : rgbY,
                })
                .attr("xlink:href", rgbImage.src);
          // rgb pane
              d3.select("#clipRGB")
                .attr({
                "height": rgbZoomPaneHeight,
                "width": rgbZoomPaneWidth,
                "x" : rgbZoomPaneX,
                "y" : rgbZoomPaneY
                });
              d3.select("#clipRGBFrame")
                .attr({
                "height": rgbZoomPaneHeight,
                "width": rgbZoomPaneWidth,
                "x" : rgbZoomPaneX,
                "y" : rgbZoomPaneY,
                "fill-opacity": 0,
                "fill": "lightgray",
                "stroke": "lightgray",
                "stroke-width": imagePadding,
                "stroke-opacity": 0.5
                });

              var clipRGBImage = d3.select("#clipRGBImage")
                .attr("xlink:href", rgbImage.src)
                .attr({
                "height": rgbImage.naturalHeight,
                "width": rgbImage.naturalWidth,
                "x" : 0,
                "y" : 0
                });

        // red pane
              d3.select("#clipRed")
                .attr({
                "height": zoomPaneHeight,
                "width": zoomPaneWidth,
                "x" : redZoomPaneX,
                "y" : redZoomPaneY
                });
              d3.select("#clipRedFrame")
                .attr({
                "height": zoomPaneHeight,
                "width": zoomPaneWidth,
                "x" : redZoomPaneX,
                "y" : redZoomPaneY,
                "fill-opacity": 0,
                "fill": "gray",
                "stroke": "red",
                "stroke-width": imagePadding,
                "stroke-opacity": 0.5
                });

              var redImage = d3.select("#redImage")
                .attr("xlink:href", redImage.src)
                .attr({
                "height": rgbImage.naturalHeight,
                "width": rgbImage.naturalWidth,
                "x" : 0,
                "y" : 0
                });
        //green pane
              d3.select("#clipGreen")
                .attr({
                "height": zoomPaneHeight,
                "width": zoomPaneWidth,
                "x" : greenZoomPaneX,
                "y" : greenZoomPaneY
                });
              d3.select("#clipGreenFrame")
                .attr({
                "height": zoomPaneHeight,
                "width": zoomPaneWidth,
                "x" : greenZoomPaneX,
                "y" : greenZoomPaneY,
                "fill-opacity": 0,
                "fill": "gray",
                "stroke": "green",
                "stroke-width": imagePadding,
                "stroke-opacity": 0.5
                });

              var greenImage = d3.select("#greenImage")
                .attr("xlink:href", greenImage.src)
                .attr({
                "height": rgbImage.naturalHeight,
                "width": rgbImage.naturalWidth,
                "x" : 0,
                "y" : 0
                });
        //blue pane
                d3.select("#clipBlue")
                  .attr({
                  "height": zoomPaneHeight,
                  "width": zoomPaneWidth,
                  "x" : blueZoomPaneX,
                  "y" : blueZoomPaneY
                  });
                d3.select("#clipBlueFrame")
                  .attr({
                  "height": zoomPaneHeight,
                  "width": zoomPaneWidth,
                  "x" : blueZoomPaneX,
                  "y" : blueZoomPaneY,
                  "fill-opacity": 0,
                  "fill": "gray",
                  "stroke": "blue",
                  "stroke-width": imagePadding,
                  "stroke-opacity": 0.5
                  });

                var blueImage = d3.select("#blueImage")
                  .attr("xlink:href", blueImage.src)
                  .attr({
                  "height": rgbImage.naturalHeight,
                  "width": rgbImage.naturalWidth,
                  "x" : 0,
                  "y" : 0
                  });

        //gray pane
              d3.select("#clipGray")
                .attr({
                "height": zoomPaneHeight,
                "width": zoomPaneWidth,
                "x" : grayZoomPaneX,
                "y" : grayZoomPaneY
                });
              d3.select("#clipGrayFrame")
                .attr({
                "height": zoomPaneHeight,
                "width": zoomPaneWidth,
                "x" : grayZoomPaneX,
                "y" : grayZoomPaneY,
                "fill-opacity": 0,
                "fill": "gray",
                "stroke": "gray",
                "stroke-width": imagePadding,
                "stroke-opacity": 0.5
                });

              var grayImage = d3.select("#grayImage")
                .attr("xlink:href", grayImage.src)
                .attr({
                "height": rgbImage.naturalHeight,
                "width": rgbImage.naturalWidth,
                "x" : 0,
                "y" : 0
                });

            var svg = d3.select("body").select("svg")
                  .attr("width", svgWidth)
                  .attr("height", svgHeight);

            //add scale bar
            var scaleBarWidth = Math.floor((scaleBarSize*micronPixelRatio)*(rgbWidth/rgbImage.naturalWidth));
            console.log("width to natural width: "+rgbWidth/rgbImage.naturalWidth);
            console.log("Natural width: "+rgbImage.naturalWidth);
            console.log("microns to pixels: "+scaleBarSize*micronPixelRatio);
            console.log("Scale bar width: "+scaleBarWidth);
            svg.append("rect")
                .attr("x", scaleBarX)
                .attr("y", scaleBarY)
                .attr("height", scaleBarHeight)
                .attr("width", scaleBarWidth)
                .attr("fill-opacity", 0.9)
                .attr("fill", "lightgray")
                .attr("stroke","lightgray")
                .attr("stroke-width",0)
                .attr("stroke-opacity",0.9);

            svg.append("text")
                .attr("x", scaleBarX+scaleBarWidth/2-25)
                .attr("y", scaleBarY-scaleBarHeight-imagePadding)
                .attr("font-family", "sans-serif")
                .attr("font-size", 20)
                .attr("fill", "lightgray")
                .attr("fill-opacity", 0.9)
                .text(scaleBarSize+" µm");

            //resizable zoom rectangle code begin

              var width = 100,
                  height = 100,
                  rectStrokeWidth = 3,
                  dragBarWidth = 10;

              var drag = d3.behavior.drag()
                  .origin(Object)
                  .on("drag", zoomerMove);

              var dragright = d3.behavior.drag()
                  .origin(Object)
                  .on("drag", rightZoomerResize);

              var dragleft = d3.behavior.drag()
                  .origin(Object)
                  .on("drag", leftZoomerResize);

              var dragtop = d3.behavior.drag()
                  .origin(Object)
                  .on("drag", topZoomerResize);

              var dragbottom = d3.behavior.drag()
                  .origin(Object)
                  .on("drag", bottomZoomerResize);

              var bigRGBImageHandle = svg.select("#bigRGBImageGroup").append("g")
                    .data([{x: width / 2, y: height / 2}]);

              var zoomerRect = bigRGBImageHandle.append("rect")
                    .attr("id", "active")
                    .attr("x", function(d) { return d.x; })
                    .attr("y", function(d) { return d.y; })
                    .attr("height", height)
                    .attr("width", width)
                    .attr("fill-opacity", 0)
                    .attr("cursor", "move")
                    .attr("fill", "lightgray")
                    .attr("stroke","lightgray")
                    .attr("stroke-width",rectStrokeWidth)
                    .attr("stroke-opacity",0.7)
                    .call(drag);

              var zoomerHandleLeft = bigRGBImageHandle.append("rect")
                    .attr("x", function(d) { return d.x - (dragBarWidth/2); })
                    .attr("y", function(d) { return d.y + (dragBarWidth/2); })
                    .attr("height", height - dragBarWidth)
                    .attr("id", "dragleft")
                    .attr("width", dragBarWidth)
                    .attr("fill", "gray")
                    .attr("fill-opacity", 0)
                    .attr("cursor", "ew-resize")
                    .call(dragleft);

              var zoomerHandleRight = bigRGBImageHandle.append("rect")
                    .attr("x", function(d) { return d.x + width - (dragBarWidth/2); })
                    .attr("y", function(d) { return d.y + (dragBarWidth/2); })
                    .attr("id", "dragright")
                    .attr("height", height - dragBarWidth)
                    .attr("width", dragBarWidth)
                    .attr("fill", "gray")
                    .attr("fill-opacity", 0)
                    .attr("cursor", "ew-resize")
                    .call(dragright);

              var zoomerHandleTop = bigRGBImageHandle.append("rect")
                    .attr("x", function(d) { return d.x + (dragBarWidth/2); })
                    .attr("y", function(d) { return d.y - (dragBarWidth/2); })
                    .attr("height", dragBarWidth)
                    .attr("id", "dragleft")
                    .attr("width", width - dragBarWidth)
                    .attr("fill", "gray")
                    .attr("fill-opacity", 0)
                    .attr("cursor", "ns-resize")
                    .call(dragtop);

              var zoomerHandleBottom = bigRGBImageHandle.append("rect")
                    .attr("x", function(d) { return d.x + (dragBarWidth/2); })
                    .attr("y", function(d) { return d.y + height - (dragBarWidth/2); })
                    .attr("id", "dragright")
                    .attr("height", dragBarWidth)
                    .attr("width", width - dragBarWidth)
                    .attr("fill", "gray")
                    .attr("fill-opacity", 0)
                    .attr("cursor", "ns-resize")
                    .call(dragbottom);

              //adding scale bar text

              function zoomToImageCoordinate(zoomX,naturalWidth,rgbWidth,paneX){
                    var zoomImageZero = paneX - Math.ceil(zoomX*(naturalWidth/rgbWidth));
                    return zoomImageZero;
              }
              function zoomScaleNaturalSize(naturalWidth, zoomWidth, rgbWidth, zoomPaneWidth){
                    //return  Math.ceil(naturalWidth*((rgbWidth/zoomWidth)*(rgbWidth/naturalWidth)));
                    //return  Math.ceil(naturalWidth*(rgbWidth/zoomWidth)*(rgbWidth/naturalWidth));
                    //return  Math.ceil(naturalWidth*(rgbWidth/zoomWidth));
                    return  Math.ceil(rgbWidth*(rgbWidth/zoomWidth)*(zoomPaneWidth/rgbWidth));
              }
              //var rgbPanel = d3.select

              function zoomerMove(d) {

                    zoomerRect
                        .attr("x", d.x = Math.max(rgbX, Math.min(rgbWidth + rgbX - width, d3.event.x)))
                    zoomerHandleLeft
                        .attr("x", function(d) { return d.x - (dragBarWidth/2); })
                    zoomerHandleRight
                        .attr("x", function(d) { return d.x + width - (dragBarWidth/2); })
                    zoomerHandleTop
                        .attr("x", function(d) { return d.x + (dragBarWidth/2); })
                    zoomerHandleBottom
                        .attr("x", function(d) { return d.x + (dragBarWidth/2); })


                    zoomerRect
                        .attr("y", d.y = Math.max(rgbY, Math.min(rgbHeight + rgbY - height, d3.event.y)));
                    zoomerHandleLeft
                        .attr("y", function(d) { return d.y + (dragBarWidth/2); });
                    zoomerHandleRight
                        .attr("y", function(d) { return d.y + (dragBarWidth/2); });
                    zoomerHandleTop
                        .attr("y", function(d) { return d.y - (dragBarWidth/2); });
                    zoomerHandleBottom
                        .attr("y", function(d) { return d.y + height - (dragBarWidth/2); });

                    //change clipping mask
                    clipRGBImage
                      .attr("width", zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, rgbZoomPaneWidth))
                      .attr("height", zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, rgbZoomPaneHeight))
                      .attr("x", zoomToImageCoordinate(d.x,zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, rgbZoomPaneWidth),rgbWidth,rgbZoomPaneX))
                      .attr("y", zoomToImageCoordinate(d.y,zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, rgbZoomPaneWidth),rgbHeight,rgbZoomPaneY));
                    redImage
                      .attr("width", zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth))
                      .attr("height", zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneHeight))
                      .attr("x", zoomToImageCoordinate(d.x,zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth),rgbWidth,redZoomPaneX))
                      .attr("y", zoomToImageCoordinate(d.y,zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneWidth),rgbHeight,redZoomPaneY));
                    greenImage
                      .attr("width", zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth))
                      .attr("height", zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneHeight))
                      .attr("x", zoomToImageCoordinate(d.x,zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth),rgbWidth,greenZoomPaneX))
                      .attr("y", zoomToImageCoordinate(d.y,zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneWidth),rgbHeight,greenZoomPaneY));
                    blueImage
                      .attr("width", zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth))
                      .attr("height", zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneHeight))
                      .attr("x", zoomToImageCoordinate(d.x,zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth),rgbWidth,blueZoomPaneX))
                      .attr("y", zoomToImageCoordinate(d.y,zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneWidth),rgbHeight,blueZoomPaneY));
                    grayImage
                      .attr("width", zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth))
                      .attr("height", zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneHeight))
                      .attr("x", zoomToImageCoordinate(d.x,zoomScaleNaturalSize(rgbImage.naturalWidth, width, rgbWidth, zoomPaneWidth),rgbWidth,grayZoomPaneX))
                      .attr("y", zoomToImageCoordinate(d.y,zoomScaleNaturalSize(rgbImage.naturalHeight, height, rgbHeight, zoomPaneWidth),rgbHeight,grayZoomPaneY));

              }

              function leftZoomerResize(d) {

                    var oldx = d.x;
                   //Max x on the right is x + width - dragBarWidth
                   //Max x on the left is 0 - (dragBarWidth/2)
                    d.x = Math.max(0, Math.min(d.x + width - (dragBarWidth / 2), d3.event.x));
                    width = width + (oldx - d.x);
                    //adding this for symetrical resize
                    height = width;

                    zoomerHandleLeft
                      .attr("x", function(d) { return d.x - (dragBarWidth / 2); });

                    zoomerRect
                      .attr("x", function(d) { return d.x; })
                      .attr("width", width)
                      .attr("height", height);

                   zoomerHandleTop
                      .attr("x", function(d) { return d.x + (dragBarWidth/2); })
                      .attr("width", width - dragBarWidth)
                      .attr("height", height - dragBarWidth);
                   zoomerHandleBottom
                      .attr("x", function(d) { return d.x + (dragBarWidth/2); })
                      .attr("width", width - dragBarWidth)
                      //added for symetrical resize
                      .attr("height", height - dragBarWidth)

              }

              function rightZoomerResize(d) {
                   //Max x on the left is x - width
                   //Max x on the right is width of screen + (dragBarWidth/2)
                   var dragx = Math.max(d.x + (dragBarWidth/2), Math.min(rgbWidth, d.x + width + d3.event.dx));

                   //recalculate width
                   width = dragx - d.x;
                   //adding this for symetrical resize
                   height = width;
                   //move the right drag handle
                   zoomerHandleRight
                      .attr("x", function(d) { return dragx - (dragBarWidth/2) });

                   //resize the drag rectangle
                   //as we are only resizing from the right, the x coordinate does not need to change
                   zoomerRect
                      .attr("width", width)
                      .attr("height", height);
                   zoomerHandleTop
                      .attr("width", width - dragBarWidth)
                      .attr("height", height - dragBarWidth);
                   zoomerHandleBottom
                      .attr("width", width - dragBarWidth)
                      .attr("height", height - dragBarWidth)
              }

              function topZoomerResize(d) {
                    var oldy = d.y;
                   //Max x on the right is x + width - dragBarWidth
                   //Max x on the left is 0 - (dragBarWidth/2)
                    d.y = Math.max(0, Math.min(d.y + height - (dragBarWidth / 2), d3.event.y));
                    height = height + (oldy - d.y);
                    //adding this for symetrical resize
                    width = height;
                    zoomerHandleTop
                      .attr("y", function(d) { return d.y - (dragBarWidth / 2); });

                    zoomerRect
                      .attr("y", function(d) { return d.y; })
                      .attr("height", height)
                      .attr("width", width);

                    zoomerHandleLeft
                      .attr("y", function(d) { return d.y + (dragBarWidth/2); })
                      .attr("height", height - dragBarWidth)
                      .attr("width", width - dragBarWidth);
                    zoomerHandleRight
                      .attr("y", function(d) { return d.y + (dragBarWidth/2); })
                      .attr("height", height - dragBarWidth)
                      .attr("width", width - dragBarWidth);
              }

              function bottomZoomerResize(d) {
                   //Max x on the left is x - width
                   //Max x on the right is width of screen + (dragBarWidth/2)
                   var dragy = Math.max(d.y + (dragBarWidth/2), Math.min(rgbHeight, d.y + height + d3.event.dy));

                   //recalculate width
                   height = dragy - d.y;
                   //adding this for symetrical resize
                   width = height;
                   //move the right drag handle
                   zoomerHandleBottom
                      .attr("y", function(d) { return dragy - (dragBarWidth/2) });

                   //resize the drag rectangle
                   //as we are only resizing from the right, the x coordinate does not need to change
                   zoomerRect
                      .attr("height", height)
                      .attr("width", width);
                   zoomerHandleLeft
                      .attr("height", height - dragBarWidth);
                   zoomerHandleRight
                      .attr("height", height - dragBarWidth)
                      .attr("width", width - dragBarWidth);
          }
      }
    //resizable zoom rectangle code end

    //prealod all images before starting
    var rgbImage = new Image();
    rgbImage.src = imageFolder+rgbImageFileName;
    rgbImage.addEventListener("load", function() {
      console.log("rgb image loaded "+rgbImage.src);
      var redImage = new Image();
      redImage.src = imageFolder+redImageFileName;
      redImage.addEventListener("load", function() {
        console.log("red image loaded "+redImage.src);
        var greenImage = new Image();
        greenImage.src = imageFolder+greenImageFileName;
        greenImage.addEventListener("load", function() {
          console.log("green image loaded "+greenImage.src);
          var blueImage = new Image();
          blueImage.src = imageFolder+blueImageFileName;
          blueImage.addEventListener("load", function() {
            console.log("blue image loaded "+blueImage.src);
            var grayImage = new Image();
            grayImage.src = imageFolder+grayImageFileName;
            grayImage.addEventListener("load", function() {
              console.log("gray image loaded "+grayImage.src);
              mainSVG(rgbImage, redImage, greenImage, blueImage, grayImage);
            });
          });
        });
      });
    });

  }
  function saveSVGImage(){
    console.log("Button Pressed");

    var html = d3.select("body").select("svg")
        .attr("title", "uViewer.js_render.svg")
        .attr("version", 1.1)
        .attr("xmlns", "http://www.w3.org/2000/svg")
        .node().parentNode.innerHTML;

    d3.select("body").append("div")
        .attr("id", "download")
        .append("a")
        .html("Click here to download svg file")
        .attr("href", "data:image/svg+xml;base64,"+ btoa(html))
        .attr("download", "svg_figure");
  }

  </script>


  <style>
  body {
    margin: 50;
  }
  </style>
</head>
<body onload="uViewer()">
  <div>
    <svg>
      <g id="bigRGBImageGroup">
        <image id="bigRGBImage">
      </g>
      <g>
        <clipPath id="clipPathRGB">
          <rect id="clipRGB"/>
        </clipPath>
          <image id="clipRGBImage" clip-path="url(#clipPathRGB)">
      </g>
      <g>
        <rect id="clipRGBFrame"/>
      </g>
      <g>
        <clipPath id="clipPathRed">
          <rect id="clipRed"/>
        </clipPath>
          <image id="redImage" clip-path="url(#clipPathRed)">
      </g>
      <g>
        <rect id="clipRedFrame"/>
      </g>

      <g>
        <clipPath id="clipPathGreen">
          <rect id="clipGreen"/>
        </clipPath>
          <image id="greenImage" clip-path="url(#clipPathGreen)">
      </g>
      <g>
        <rect id="clipGreenFrame"/>
      </g>

      <g>
        <clipPath id="clipPathBlue">
          <rect id="clipBlue"/>
        </clipPath>
          <image id="blueImage" clip-path="url(#clipPathBlue)">
      </g>
      <g>
        <rect id="clipBlueFrame"/>
      </g>

      <g>
        <clipPath id="clipPathGray">
          <rect id="clipGray"/>
        </clipPath>
          <image id="grayImage" clip-path="url(#clipPathGray)">
      </g>
      <g>
        <rect id="clipGrayFrame"/>
      </g>

    </svg>
  </div>
  <div id="saveButtonDiv">
    <br><br>
        <input name="saveButton"
           type="button"
           value="Save SVG Image"
           onclick="saveSVGImage()" />
           <p>Todo:<br>-Responsive Grid</p>
  </div>
</body>
</html>
